<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Comprehensive test suite for PCAGraphLoader with all graph types" />
    <meta name="keywords" content="PCAGraphLoader, test, graphs, SVG, LaTeX" />
    <title>PCAGraphLoader - Main Test Suite</title>

    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
          integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn"
          crossorigin="anonymous" />
    <script defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"
            integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx"
            crossorigin="anonymous"></script>

    <!-- DaisyUI for graph styling -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/dist/full.min.css" rel="stylesheet" type="text/css" />

    <style>
        :root {
            --primary-color: #2563eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Control Panel */
        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .config-title {
            margin-bottom: 1rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .control-group input {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            width: 120px;
        }

        button {
            padding: 0.625rem 1.25rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        button.secondary {
            background: var(--text-secondary);
        }

        button.secondary:hover {
            background: #475569;
        }

        /* Status Bar */
        .status-bar {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-color);
            font-size: 0.875rem;
            font-family: monospace;
        }

        .status-bar.success {
            border-left-color: var(--success-color);
            background: #f0fdf4;
        }

        .status-bar.error {
            border-left-color: var(--error-color);
            background: #fef2f2;
        }

        /* Graph Grid - Single Column Layout */
        .graphs-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .graph-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .graph-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .graph-id {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-family: monospace;
            background: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Graph Display Area */
        .graph-content {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }

        .graph-display {
            flex: 0 0 auto;
            padding: 1rem;
            background: var(--bg-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .graph-display svg {
            width: auto;
            height: auto;
            max-width: 340px;
            max-height: 340px;
            display: block;
        }

        /* Graph Info Panel */
        .graph-info {
            flex: 1;
            min-width: 0;
            /* Allow flex item to shrink */
        }

        .dimension-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            font-family: monospace;
        }

        .dimension-check {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }

        .check-pass {
            color: var(--success-color);
            font-weight: 600;
        }

        .check-fail {
            color: var(--error-color);
            font-weight: 600;
        }

        /* Graph Dictionary Display */
        details {
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        summary {
            padding: 0.75rem;
            background: var(--bg-color);
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
            user-select: none;
            transition: background 0.2s;
        }

        summary:hover {
            background: #f1f5f9;
        }

        details[open] summary {
            border-bottom: 1px solid var(--border-color);
        }

        .dict-content {
            padding: 1rem;
            background: #fafafa;
            max-height: 400px;
            overflow-y: auto;
        }

        .dict-content pre {
            margin: 0;
            font-size: 0.75rem;
            line-height: 1.4;
            white-space: pre;
            overflow-x: auto;
            max-width: 100%;
            background: white;
            padding: 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* LaTeX Rendering Styles */
        .svg-latex {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 0;
            box-sizing: border-box;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        foreignObject .katex {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1 !important;
            font-size: inherit !important;
            color: inherit !important;
            text-align: center;
        }

        foreignObject div {
            height: 100%;
            width: 100%;
            color: inherit !important;
        }

        /* Essential text size for graph labels */
        .text-2xs {
            font-size: 0.625rem !important;
            line-height: 1 !important;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .graph-content {
                flex-direction: column;
            }

            .graph-display {
                width: 100%;
                text-align: center;
            }
        }

        /* Config Parameters Section */
        .config-section {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .config-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .config-value {
            font-family: monospace;
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>🧪 PCAGraphLoader Test Suite</h1>
        <p class="subtitle">
          Comprehensive testing of all graph types with LaTeX rendering and dimension verification
        </p>
      </header>

      <div class="control-panel">
        <h3 class="config-title">Configuration Parameters</h3>
        <div class="controls">
          <div class="control-group">
            <label for="y-horizontal">Y Horizontal Line</label>
            <input type="number" id="y-horizontal" value="10" min="-20" max="20" />
          </div>
          <div class="control-group">
            <label for="a-affine">Affine Slope (a)</label>
            <input type="number" id="a-affine" value="0.75" step="0.25" min="-5" max="5" />
          </div>
          <div class="control-group">
            <label for="b-affine">Affine Intercept (b)</label>
            <input type="number" id="b-affine" value="2" min="-10" max="10" />
          </div>
          <div class="control-group">
            <label for="a-shift">Shift Magnitude</label>
            <input type="number" id="a-shift" value="5" min="1" max="10" />
          </div>
          <button id="run-tests">Run All Tests</button>
          <button id="apply-config" class="secondary">Apply Config</button>
        </div>
      </div>

      <div id="status" class="status-bar">Ready to run tests...</div>

      <div id="graphs-container" class="graphs-container">
        <!-- Graphs will be dynamically inserted here -->
      </div>
    </div>

    <script type="module">
        // IMPORTANT: Use v0.0.24 for parameter passing to work correctly
        import {
            PCAGraphLoader
        } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/v4.py.js@v0.0.24/scenery/packaged/PCAGraphLoader.js';

        // All small graphs to test
        const TEST_GRAPHS = [{
            id: 'q7_small',
            name: 'Question 7 - Parabola with Horizontal Line',
            configurable: ['Y_LABEL_FOR_HORIZONTAL_LINE']
        }, {
            id: 'q8_small',
            name: 'Question 8 - Affine Function',
            configurable: ['A_FLOAT_FOR_AFFINE_LINE', 'B_FLOAT_FOR_AFFINE_LINE']
        }, {
            id: 'q11_case_a_small',
            name: 'Question 11 - Case A',
            configurable: []
        }, {
            id: 'q11_case_b_small',
            name: 'Question 11 - Case B',
            configurable: []
        }, {
            id: 'q11_case_c_small',
            name: 'Question 11 - Case C',
            configurable: []
        }, {
            id: 'parabola_s1_a0',
            name: 'Upward Parabola: y = x²',
            configurable: []
        }, {
            id: 'parabola_s1_am',
            name: 'Upward Parabola: y = x² - a',
            configurable: ['A_SHIFT_MAGNITUDE']
        }, {
            id: 'parabola_s1_ap',
            name: 'Upward Parabola: y = x² + a',
            configurable: ['A_SHIFT_MAGNITUDE']
        }, {
            id: 'parabola_sm1_a0',
            name: 'Downward Parabola: y = -x²',
            configurable: []
        }, {
            id: 'parabola_sm1_am',
            name: 'Downward Parabola: y = -x² - a',
            configurable: ['A_SHIFT_MAGNITUDE']
        }, {
            id: 'parabola_sm1_ap',
            name: 'Downward Parabola: y = -x² + a',
            configurable: ['A_SHIFT_MAGNITUDE']
        }];

        let loader = null;

        // Get current config from inputs
        function getConfig() {
            // Handle both comma and dot as decimal separator
            const parseFloatFlexible = (value) => {
                if (typeof value === 'string') {
                    // Replace comma with dot for European format
                    value = value.replace(',', '.');
                }
                return parseFloat(value);
            };

            return {
                Y_LABEL_FOR_HORIZONTAL_LINE: parseFloatFlexible(document.getElementById('y-horizontal').value),
                A_FLOAT_FOR_AFFINE_LINE: parseFloatFlexible(document.getElementById('a-affine').value),
                B_FLOAT_FOR_AFFINE_LINE: parseFloatFlexible(document.getElementById('b-affine').value),
                A_SHIFT_MAGNITUDE: parseInt(document.getElementById('a-shift').value)
            };
        }

        // Update status bar
        function updateStatus(message, type = 'info') {
            const statusBar = document.getElementById('status');
            statusBar.textContent = message;
            statusBar.className = `status-bar ${type}`;
        }

        // Render LaTeX in element
        function renderLatexInElement(element) {
            if (typeof katex === 'undefined') return;

            setTimeout(() => {
                const foreignObjects = element.querySelectorAll('foreignObject');
                foreignObjects.forEach((fo) => {
                    const divs = fo.querySelectorAll('div.svg-latex');
                    divs.forEach((div) => {
                        const latex = div.textContent.trim();
                        if (latex) {
                            try {
                                const bgColor = div.style.backgroundColor;
                                const color = div.style.color;
                                div.innerHTML = '';
                                katex.render(latex, div, {
                                    throwOnError: false,
                                    displayMode: false,
                                });
                                if (bgColor) div.style.backgroundColor = bgColor;
                                if (color) {
                                    div.querySelectorAll('.katex, .katex *').forEach(el => {
                                        el.style.color = color;
                                    });
                                }
                            } catch (e) {
                                console.error('KaTeX error:', e);
                                div.textContent = latex;
                            }
                        }
                    });
                });
            }, 100);
        }

        // Create graph card
        function createGraphCard(graphInfo, result, config) {
            const card = document.createElement('div');
            card.className = 'graph-card';

            // Header
            const header = document.createElement('div');
            header.className = 'graph-header';
            header.innerHTML = `
                <div class="graph-title">${graphInfo.name}</div>
                <div class="graph-id">${graphInfo.id}</div>
            `;
            card.appendChild(header);

            // Config section if applicable
            if (graphInfo.configurable.length > 0) {
                const configSection = document.createElement('div');
                configSection.className = 'config-section';
                configSection.innerHTML = `
                    <div class="config-label">Applied Configuration:</div>
                    ${graphInfo.configurable.map(key => `
                        <span class="config-value">${key}: ${config[key]}</span>
                    `).join(' ')}
                `;
                card.appendChild(configSection);
            }

            // Content area
            const content = document.createElement('div');
            content.className = 'graph-content';

            // Graph display
            const graphDisplay = document.createElement('div');
            graphDisplay.className = 'graph-display';
            graphDisplay.innerHTML = result.svg;
            content.appendChild(graphDisplay);

            // Info panel
            const infoPanel = document.createElement('div');
            infoPanel.className = 'graph-info';

            // Dimension verification
            const svgElement = graphDisplay.querySelector('svg');
            const dictWidth = result.graphDict.svg?.width;
            const dictHeight = result.graphDict.svg?.height;
            const svgWidth = svgElement?.getAttribute('width');
            const svgHeight = svgElement?.getAttribute('height');
            const expectedWidth = 150; // All small graphs should be 150x150
            const expectedHeight = 150;

            const widthMatch = dictWidth == svgWidth && dictWidth == expectedWidth;
            const heightMatch = dictHeight == svgHeight && dictHeight == expectedHeight;

            const dimensionInfo = document.createElement('div');
            dimensionInfo.className = 'dimension-info';
            dimensionInfo.innerHTML = `
                <div class="dimension-check">
                    <span>Expected: ${expectedWidth} × ${expectedHeight}</span>
                    <span class="${widthMatch && heightMatch ? 'check-pass' : 'check-fail'}">
                        ${widthMatch && heightMatch ? '✓ PASS' : '✗ FAIL'}
                    </span>
                </div>
                <div class="dimension-check">
                    <span>Dict: ${dictWidth} × ${dictHeight}</span>
                    <span class="${dictWidth == expectedWidth && dictHeight == expectedHeight ? 'check-pass' : 'check-fail'}">
                        ${dictWidth == expectedWidth && dictHeight == expectedHeight ? '✓' : '✗'}
                    </span>
                </div>
                <div class="dimension-check">
                    <span>SVG: ${svgWidth} × ${svgHeight}</span>
                    <span class="${svgWidth == expectedWidth && svgHeight == expectedHeight ? 'check-pass' : 'check-fail'}">
                        ${svgWidth == expectedWidth && svgHeight == expectedHeight ? '✓' : '✗'}
                    </span>
                </div>
                <div class="dimension-check">
                    <span>Rendered: ${svgElement?.clientWidth} × ${svgElement?.clientHeight}</span>
                    <span style="color: var(--text-secondary)">CSS constrained</span>
                </div>
            `;
            infoPanel.appendChild(dimensionInfo);

            // Graph Dictionary
            const details = document.createElement('details');
            details.innerHTML = `
                <summary>Graph Dictionary (${Object.keys(result.graphDict).length} keys)</summary>
                <div class="dict-content">
                    <pre>${JSON.stringify(result.graphDict, null, 2)}</pre>
                </div>
            `;
            infoPanel.appendChild(details);

            content.appendChild(infoPanel);
            card.appendChild(content);

            // Render LaTeX
            // Render LaTeX with a small delay to ensure DOM is updated
            setTimeout(() => {
                renderLatexInElement(graphDisplay);
            }, 100);

            return card;
        }

        // Run all tests
        async function runAllTests() {
            const container = document.getElementById('graphs-container');
            const config = getConfig();

            // Clear container
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            updateStatus('Initializing PCAGraphLoader...', 'info');

            try {
                // Initialize loader with current config from form
                loader = new PCAGraphLoader({
                    debug: false,
                    graphConfig: config // Pass the form config to the loader
                });
                await loader.initialize();

                updateStatus(`Testing ${TEST_GRAPHS.length} graphs...`, 'info');

                // Clear loading spinner
                container.innerHTML = '';

                // Test each graph
                let successCount = 0;
                for (const graphInfo of TEST_GRAPHS) {
                    try {
                        // Apply config for this specific graph
                        const graphConfig = {};
                        graphInfo.configurable.forEach(key => {
                            if (config[key] !== undefined) {
                                graphConfig[key] = config[key];
                            }
                        });

                        // Render graph with full config (not just configurable items)
                        // Pass the entire config to ensure all values are available
                        const result = await loader.renderGraph(graphInfo.id, config);

                        // Create and append card
                        const card = createGraphCard(graphInfo, result, config);
                        container.appendChild(card);

                        successCount++;
                    } catch (error) {
                        console.error(`Failed to render ${graphInfo.id}:`, error);

                        // Create error card
                        const errorCard = document.createElement('div');
                        errorCard.className = 'graph-card';
                        errorCard.style.borderLeft = '4px solid var(--error-color)';
                        errorCard.innerHTML = `
                            <div class="graph-header">
                                <div class="graph-title">${graphInfo.name}</div>
                                <div class="graph-id">${graphInfo.id}</div>
                            </div>
                            <div style="color: var(--error-color); padding: 1rem;">
                                Error: ${error.message}
                            </div>
                        `;
                        container.appendChild(errorCard);
                    }
                }

                updateStatus(`✅ Tests complete: ${successCount}/${TEST_GRAPHS.length} graphs rendered successfully`,
                    successCount === TEST_GRAPHS.length ? 'success' : 'warning');

            } catch (error) {
                updateStatus(`❌ Test suite failed: ${error.message}`, 'error');
                console.error('Test suite error:', error);
                container.innerHTML = `
                    <div class="graph-card" style="text-align: center; color: var(--error-color);">
                        <h3>Test Suite Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Apply config and re-run tests
        async function applyConfig() {
            await runAllTests();
        }

        // Event listeners
        document.getElementById('run-tests').addEventListener('click', runAllTests);
        document.getElementById('apply-config').addEventListener('click', applyConfig);

        // Auto-run tests on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllTests, 500);
        });

        // Log initial message
        console.log('🧪 PCAGraphLoader Main Test Suite');
        console.log('📊 Testing all _small graphs with full feature verification');
        console.log('✨ Features: LaTeX rendering, dimension checking, config parameters');
    </script>
  </body>
</html>

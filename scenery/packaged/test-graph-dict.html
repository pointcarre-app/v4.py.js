<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Graph Dictionary Return</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 { color: #00ffff; }
        .container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .box {
            flex: 1;
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .graph-box {
            text-align: center;
        }
        .graph-box svg {
            width: auto;
            height: auto;
            max-width: 340px;
            max-height: 340px;
            margin: 20px auto;
            display: block;
        }
        pre {
            margin: 0;
            font-size: 12px;
            line-height: 1.4;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #ffff00; }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00ff00;
            color: #000;
        }
        .highlight {
            background: #333;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>üîç Graph Dictionary Return Test</h1>
    
    <div style="margin: 20px 0;">
        <button onclick="testRenderGraph()">Test renderGraph()</button>
        <button onclick="testRenderGraphSvg()">Test renderGraphSvg()</button>
        <button onclick="testWithConfig()">Test with Config</button>
    </div>
    
    <div class="container">
        <div class="box graph-box">
            <h2>Rendered Graph</h2>
            <div id="graph-display">
                <p style="color: #666;">Click a button to render a graph</p>
            </div>
        </div>
        
        <div class="box">
            <h2>Graph Dictionary</h2>
            <pre id="dict-display">No graph dictionary loaded yet</pre>
        </div>
    </div>
    
    <div class="box">
        <h2>Console Output</h2>
        <pre id="console-output"></pre>
    </div>

    <script type="module">
        import { PCAGraphLoader } from './PCAGraphLoader.js';
        
        let loader;
        const output = document.getElementById('console-output');
        const dictDisplay = document.getElementById('dict-display');
        const graphDisplay = document.getElementById('graph-display');
        
        function log(msg, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const line = `<span class="${type}">[${timestamp}] ${msg}</span>\n`;
            output.innerHTML += line;
            output.scrollTop = output.scrollHeight;
        }
        
        // Initialize loader
        async function init() {
            try {
                log('Initializing PCAGraphLoader...', 'info');
                loader = new PCAGraphLoader({ debug: false });
                await loader.initialize();
                log('‚úÖ Loader initialized successfully', 'success');
                window.loader = loader;
            } catch (error) {
                log(`‚ùå Initialization failed: ${error.message}`, 'error');
            }
        }
        
        window.testRenderGraph = async function() {
            if (!loader) {
                log('Loader not initialized', 'error');
                return;
            }
            
            try {
                log('\n=== Testing renderGraph() ===', 'info');
                log('Calling loader.renderGraph("q8_small")...', 'info');
                
                const result = await loader.renderGraph('q8_small');
                
                log(`‚úÖ Result type: ${typeof result}`, 'success');
                log(`‚úÖ Has svg property: ${!!result.svg}`, 'success');
                log(`‚úÖ Has graphDict property: ${!!result.graphDict}`, 'success');
                log(`‚úÖ SVG length: ${result.svg.length} characters`, 'success');
                log(`‚úÖ Graph dict keys: ${Object.keys(result.graphDict).join(', ')}`, 'success');
                
                // Display the graph
                graphDisplay.innerHTML = result.svg;
                
                // Display the dictionary
                dictDisplay.textContent = JSON.stringify(result.graphDict, null, 2);
                
                // Log some specific values
                log(`\nGraph Details:`, 'info');
                log(`  ID: ${result.graphDict.id}`, 'info');
                log(`  Title: ${result.graphDict.title}`, 'info');
                log(`  Description: ${result.graphDict.description}`, 'info');
                if (result.graphDict.svg) {
                    log(`  SVG dimensions: ${result.graphDict.svg.width}x${result.graphDict.svg.height}`, 'info');
                }
                if (result.graphDict.settings) {
                    log(`  X range: ${JSON.stringify(result.graphDict.settings.x_range)}`, 'info');
                    log(`  Y range: ${JSON.stringify(result.graphDict.settings.y_range)}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testRenderGraphSvg = async function() {
            if (!loader) {
                log('Loader not initialized', 'error');
                return;
            }
            
            try {
                log('\n=== Testing renderGraphSvg() (backward compatibility) ===', 'info');
                log('Calling loader.renderGraphSvg("q7_small")...', 'info');
                
                const svg = await loader.renderGraphSvg('q7_small');
                
                log(`‚úÖ Result type: ${typeof svg}`, 'success');
                log(`‚úÖ Is string: ${typeof svg === 'string'}`, 'success');
                log(`‚úÖ SVG length: ${svg.length} characters`, 'success');
                log(`‚úÖ Starts with <svg: ${svg.trim().startsWith('<svg')}`, 'success');
                
                // Display the graph
                graphDisplay.innerHTML = svg;
                
                // No dictionary in this case
                dictDisplay.textContent = 'renderGraphSvg() returns only SVG (no dictionary)';
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        window.testWithConfig = async function() {
            if (!loader) {
                log('Loader not initialized', 'error');
                return;
            }
            
            try {
                log('\n=== Testing renderGraph() with config ===', 'info');
                log('Rendering parabola with custom shift magnitude...', 'info');
                
                const result = await loader.renderGraph('parabola_s1_ap', {
                    A_SHIFT_MAGNITUDE: 7
                });
                
                log(`‚úÖ Rendered with config: A_SHIFT_MAGNITUDE = 7`, 'success');
                log(`‚úÖ Graph dict available with ${Object.keys(result.graphDict).length} keys`, 'success');
                
                // Display the graph
                graphDisplay.innerHTML = result.svg;
                
                // Display the dictionary
                dictDisplay.textContent = JSON.stringify(result.graphDict, null, 2);
                
                // Check if the config was applied (would be in the lines or other elements)
                log(`\nGraph contains ${result.graphDict.lines ? result.graphDict.lines.length : 0} lines`, 'info');
                log(`Graph contains ${result.graphDict.foreign_objects ? result.graphDict.foreign_objects.length : 0} foreign objects`, 'info');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        };
        
        // Initialize on load
        init();
    </script>
</body>
</html>

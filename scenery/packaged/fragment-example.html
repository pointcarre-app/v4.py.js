<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PCA Graph Fragment Example</title>

    <style>
        /* Your page's existing styles */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
        }

        .content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .graph-section {
            margin: 30px 0;
        }

        .graph-section h2 {
            color: #666;
            font-size: 18px;
            margin-bottom: 15px;
        }

        /* Custom DaisyUI theme colors for graphs */
        :root {
            /* Using custom blue/purple/red scheme */
            --p: 217 91% 60%;
            /* Blue primary */
            --s: 271 81% 56%;
            /* Purple secondary */
            --a: 0 72% 51%;
            /* Red accent */
        }
    </style>

    <!-- Include the PCA Graph Fragment (this would be {% include 'graph-loader-partial.html' %} in Jinja) -->
    <!-- START OF FRAGMENT -->
    <!-- DaisyUI for consistent styling and color system -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/dist/full.min.css" rel="stylesheet" type="text/css" />

    <!-- KaTeX for LaTeX rendering in graphs -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
          integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn"
          crossorigin="anonymous" />
    <script defer
            src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"
            integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx"
            crossorigin="anonymous"></script>

    <!-- Minimal CSS for PCA Graphs Only -->
    <style>
        /* Scoped styles for PCA graphs - prefixed to avoid conflicts */
        .pca-graph-container {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
        }

        .pca-graph-frame {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            background: white;
        }

        .pca-graph-container svg {
            width: auto;
            height: auto;
            max-width: 340px;
            max-height: 340px;
            display: block;
        }

        /* Essential text size for graph labels */
        .pca-graph-container .text-2xs {
            font-size: 0.625rem !important;
            line-height: 1 !important;
        }

        /* LaTeX rendering in graphs */
        .pca-graph-container .svg-latex {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            padding: 0;
            box-sizing: border-box;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .pca-graph-container foreignObject .katex {
            margin: 0 !important;
            padding: 0 !important;
            line-height: 1 !important;
            font-size: inherit !important;
            color: inherit !important;
            text-align: center;
        }

        .pca-graph-container foreignObject div {
            height: 100%;
            width: 100%;
            color: inherit !important;
        }

        /* Essential SVG color classes - DaisyUI compatible */
        .pca-graph-container .stroke-primary {
            stroke: hsl(var(--p, 221 83% 53%)) !important;
        }

        .pca-graph-container .fill-primary {
            fill: hsl(var(--p, 221 83% 53%)) !important;
        }

        .pca-graph-container .text-primary {
            color: hsl(var(--p, 221 83% 53%)) !important;
        }

        .pca-graph-container .stroke-secondary {
            stroke: hsl(var(--s, 262 52% 46%)) !important;
        }

        .pca-graph-container .fill-secondary {
            fill: hsl(var(--s, 262 52% 46%)) !important;
        }

        .pca-graph-container .text-secondary {
            color: hsl(var(--s, 262 52% 46%)) !important;
        }

        .pca-graph-container .stroke-accent {
            stroke: hsl(var(--a, 0 84% 60%)) !important;
        }

        .pca-graph-container .fill-accent {
            fill: hsl(var(--a, 0 84% 60%)) !important;
        }

        .pca-graph-container .text-accent {
            color: hsl(var(--a, 0 84% 60%)) !important;
        }

        .pca-graph-container .stroke-base-content {
            stroke: hsl(var(--bc, 215 28% 17%)) !important;
        }

        .pca-graph-container .fill-base-content {
            fill: hsl(var(--bc, 215 28% 17%)) !important;
        }

        .pca-graph-container .text-base-content {
            color: hsl(var(--bc, 215 28% 17%)) !important;
        }

        .pca-graph-container .stroke-base-100 {
            stroke: hsl(var(--b1, 0 0% 100%)) !important;
        }

        .pca-graph-container .fill-base-100 {
            fill: hsl(var(--b1, 0 0% 100%)) !important;
        }

        .pca-graph-container .stroke-base-200 {
            stroke: hsl(var(--b2, 0 0% 95%)) !important;
        }

        .pca-graph-container .fill-base-200 {
            fill: hsl(var(--b2, 0 0% 95%)) !important;
        }

        .pca-graph-container .stroke-base-300 {
            stroke: hsl(var(--b3, 0 0% 90%)) !important;
        }

        .pca-graph-container .fill-base-300 {
            fill: hsl(var(--b3, 0 0% 90%)) !important;
        }

        /* Optional: Loading state */
        .pca-graph-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #6b7280;
            font-style: italic;
        }

        /* Optional: Error state */
        .pca-graph-error {
            padding: 20px;
            background: #fee;
            color: #c00;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>

    <!-- PCAGraphLoader Module -->
    <script type="module">
        // Import PCAGraphLoader from CDN
        import {
            PCAGraphLoader
        } from 'https://cdn.jsdelivr.net/gh/pointcarre-app/v4.py.js@v0.0.15-unstable/scenery/packaged/PCAGraphLoader.js';

        // Make PCAGraphLoader available globally for use in your application
        window.PCAGraphLoader = PCAGraphLoader;

        // Helper function to render a graph into a container
        window.renderPCAGraph = async function(containerId, graphKey, config = {}) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container with id '${containerId}' not found`);
                return;
            }

            // Add loading state
            container.innerHTML = '<div class="pca-graph-loading">Loading graph...</div>';
            container.className = 'pca-graph-container';

            try {
                // Create or reuse loader instance
                if (!window._pcaLoader) {
                    window._pcaLoader = new PCAGraphLoader({
                        debug: false,
                        graphConfig: config
                    });
                    await window._pcaLoader.initialize();
                } else if (config && Object.keys(config).length > 0) {
                    // Update config if provided
                    window._pcaLoader.updateConfig(config);
                }

                // Render the graph
                const svg = await window._pcaLoader.renderGraph(graphKey);

                // Create proper frame structure
                const frameDiv = document.createElement('div');
                frameDiv.className = 'pca-graph-frame';
                frameDiv.innerHTML = svg;

                container.innerHTML = '';
                container.appendChild(frameDiv);

                // Render LaTeX if KaTeX is available
                if (typeof katex !== 'undefined') {
                    setTimeout(() => {
                        const foreignObjects = container.querySelectorAll('foreignObject');
                        foreignObjects.forEach((fo) => {
                            const divs = fo.querySelectorAll('div.svg-latex');
                            divs.forEach((div) => {
                                const latex = div.textContent.trim();
                                if (latex) {
                                    try {
                                        const bgColor = div.style.backgroundColor;
                                        const color = div.style.color;
                                        div.innerHTML = '';
                                        katex.render(latex, div, {
                                            throwOnError: false,
                                            displayMode: false,
                                        });
                                        if (bgColor) div.style.backgroundColor = bgColor;
                                        if (color) {
                                            div.querySelectorAll('.katex, .katex *').forEach(el => {
                                                el.style.color = color;
                                            });
                                        }
                                    } catch (e) {
                                        console.error('KaTeX error:', e);
                                        div.textContent = latex;
                                    }
                                }
                            });
                        });
                    }, 100);
                }

            } catch (error) {
                container.innerHTML = `<div class="pca-graph-error">Error loading graph: ${error.message}</div>`;
                console.error('PCA Graph Error:', error);
            }
        };

        // Log availability
        console.log('✅ PCAGraphLoader ready. Use window.renderPCAGraph(containerId, graphKey, config) to render graphs.');
    </script>
    <!-- END OF FRAGMENT -->
  </head>
  <body>
    <h1>PCA Graph Fragment Example</h1>

    <div class="content">
      <p>
        This page demonstrates using the PCA Graph Loader fragment. The fragment above would be included via Jinja in your actual application.
      </p>
      <p>
        In Jinja: <code>
        {% include "graph-loader-partial.html" %}
      </code>
    </p>
  </div>

  <div class="graph-section">
    <h2>Question 7: Parabola with Horizontal Line</h2>
    <div id="graph1"></div>
  </div>

  <div class="graph-section">
    <h2>Question 8: Affine Function y = ax + b</h2>
    <div id="graph2"></div>
  </div>

  <div class="graph-section">
    <h2>Question 10: Parabola y = x² + 5</h2>
    <div id="graph3"></div>
  </div>

  <script>
      // Render graphs when page loads
      document.addEventListener('DOMContentLoaded', async () => {
          // Question 7 with custom Y label
          await window.renderPCAGraph('graph1', 'q7_small', {
              Y_LABEL_FOR_HORIZONTAL_LINE: 15
          });

          // Question 8 with custom slope and intercept
          await window.renderPCAGraph('graph2', 'q8_small', {
              A_FLOAT_FOR_AFFINE_LINE: 1.25,
              B_FLOAT_FOR_AFFINE_LINE: -2
          });

          // Parabola with shift
          await window.renderPCAGraph('graph3', 'parabola_s1_ap', {
              A_SHIFT_MAGNITUDE: 5
          });
      });
  </script>
</body>
</html>

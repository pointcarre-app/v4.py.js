<!DOCTYPE html>
<html>
<head>
    <title>Complete Integration Example - v0.0.21</title>
    <meta charset="UTF-8">
    <!-- ✅ IMPORTANT: KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .config-panel {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .config-panel input {
            margin: 5px 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .config-panel button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .config-panel button:hover {
            background: #45a049;
        }
        .config-panel button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .graph-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .graph-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .graph-card h3 {
            margin-top: 0;
            color: #333;
        }
        .graph-card svg {
            max-width: 100%;
            height: auto;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .parameter-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>🎯 Complete PCAGraphLoader Integration Example</h1>
    
    <div class="config-panel">
        <h2>Configuration</h2>
        <div>
            <label>Y Horizontal Line:</label>
            <input type="number" id="yValue" value="10" min="-20" max="20">
        </div>
        <div>
            <label>Affine Slope (a):</label>
            <input type="number" id="aValue" value="0.75" step="0.25" min="-5" max="5">
        </div>
        <div>
            <label>Affine Intercept (b):</label>
            <input type="number" id="bValue" value="2" step="0.5" min="-10" max="10">
        </div>
        <div>
            <label>Parabola Shift:</label>
            <input type="number" id="shiftValue" value="5" min="-10" max="10">
        </div>
        <button id="generateBtn" onclick="generateGraphs()">Generate Graphs</button>
    </div>
    
    <div id="status"></div>
    <div id="graphs" class="graph-container"></div>

    <script type="module">
        // ✅ USE v0.0.21-unstable (NOT v0.0.20)
        import { PCAGraphLoader } from "https://cdn.jsdelivr.net/gh/pointcarre-app/v4.py.js@v0.0.21-unstable/scenery/packaged/PCAGraphLoader.js";
        
        // Make it available globally for the onclick handler
        window.graphLoader = null;
        window.generateGraphs = async function generateGraphs() {
            const statusDiv = document.getElementById('status');
            const graphsDiv = document.getElementById('graphs');
            const btn = document.getElementById('generateBtn');
            
            // Get configuration values
            const config = {
                Y_LABEL_FOR_HORIZONTAL_LINE: parseInt(document.getElementById('yValue').value),
                A_FLOAT_FOR_AFFINE_LINE: parseFloat(document.getElementById('aValue').value),
                B_FLOAT_FOR_AFFINE_LINE: parseFloat(document.getElementById('bValue').value),
                A_SHIFT_MAGNITUDE: parseFloat(document.getElementById('shiftValue').value)
            };
            
            try {
                btn.disabled = true;
                btn.textContent = 'Generating...';
                statusDiv.className = 'status loading';
                statusDiv.textContent = '🔄 Initializing graph loader...';
                
                // Initialize loader if not already done
                if (!window.graphLoader) {
                    window.graphLoader = new PCAGraphLoader({ debug: false });
                    await window.graphLoader.initialize();
                    console.log('✅ PCAGraphLoader initialized');
                }
                
                statusDiv.textContent = '🔄 Generating graphs with your parameters...';
                graphsDiv.innerHTML = '';
                
                // Generate different graphs with the configuration
                const graphs = [
                    {
                        name: "q7_small",
                        title: "Question 7 - Horizontal Line",
                        params: { Y_LABEL_FOR_HORIZONTAL_LINE: config.Y_LABEL_FOR_HORIZONTAL_LINE },
                        info: `Y = ${config.Y_LABEL_FOR_HORIZONTAL_LINE}`
                    },
                    {
                        name: "q8_small", 
                        title: "Question 8 - Affine Function",
                        params: { 
                            A_FLOAT_FOR_AFFINE_LINE: config.A_FLOAT_FOR_AFFINE_LINE,
                            B_FLOAT_FOR_AFFINE_LINE: config.B_FLOAT_FOR_AFFINE_LINE
                        },
                        info: `y = ${config.A_FLOAT_FOR_AFFINE_LINE}x + ${config.B_FLOAT_FOR_AFFINE_LINE}`
                    },
                    {
                        name: "parabola_s1_ap",
                        title: "Upward Parabola with Positive Shift",
                        params: { A_SHIFT_MAGNITUDE: config.A_SHIFT_MAGNITUDE },
                        info: `y = x² + ${config.A_SHIFT_MAGNITUDE}`
                    },
                    {
                        name: "parabola_s1_am",
                        title: "Upward Parabola with Negative Shift",
                        params: { A_SHIFT_MAGNITUDE: -config.A_SHIFT_MAGNITUDE },
                        info: `y = x² - ${config.A_SHIFT_MAGNITUDE}`
                    },
                    {
                        name: "parabola_sm1_ap",
                        title: "Downward Parabola with Positive Shift",
                        params: { A_SHIFT_MAGNITUDE: config.A_SHIFT_MAGNITUDE },
                        info: `y = -x² + ${config.A_SHIFT_MAGNITUDE}`
                    },
                    {
                        name: "parabola_sm1_am",
                        title: "Downward Parabola with Negative Shift",
                        params: { A_SHIFT_MAGNITUDE: -config.A_SHIFT_MAGNITUDE },
                        info: `y = -x² - ${config.A_SHIFT_MAGNITUDE}`
                    }
                ];
                
                // Generate each graph
                for (const graph of graphs) {
                    try {
                        console.log(`📊 Generating ${graph.name} with params:`, graph.params);
                        const result = await window.graphLoader.renderGraph(graph.name, graph.params);
                        
                        // Create card for this graph
                        const card = document.createElement('div');
                        card.className = 'graph-card';
                        card.innerHTML = `
                            <h3>${graph.title}</h3>
                            ${result.svg}
                            <div class="parameter-info">Parameters: ${graph.info}</div>
                        `;
                        graphsDiv.appendChild(card);
                        
                    } catch (err) {
                        console.error(`Failed to generate ${graph.name}:`, err);
                        const card = document.createElement('div');
                        card.className = 'graph-card';
                        card.innerHTML = `
                            <h3>${graph.title}</h3>
                            <div class="status error">Failed: ${err.message}</div>
                        `;
                        graphsDiv.appendChild(card);
                    }
                }
                
                // Render LaTeX equations
                setTimeout(() => {
                    if (typeof katex !== 'undefined') {
                        document.querySelectorAll('.svg-latex').forEach(el => {
                            const latex = el.textContent;
                            if (latex) {
                                el.innerHTML = '';
                                katex.render(latex, el, { 
                                    throwOnError: false,
                                    displayMode: false
                                });
                            }
                        });
                        console.log('✅ LaTeX equations rendered');
                    }
                }, 100);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `✅ Successfully generated ${graphs.length} graphs with your parameters!`;
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
                console.error(error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Graphs';
            }
        };
        
        // Auto-generate on load
        window.addEventListener('load', () => {
            setTimeout(() => window.generateGraphs(), 500);
        });
    </script>
</body>
</html>
